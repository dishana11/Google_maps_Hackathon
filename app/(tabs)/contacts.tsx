import React, { useState, useEffect } from 'react';
import { View, Text, StyleSheet, TouchableOpacity, ScrollView, Alert, TextInput, Modal } from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { Plus, Search, Globe } from 'lucide-react-native';
import { ContactCard } from '../../components/ContactCard';
import { useTheme } from '../../contexts/ThemeContext';
import { CommonStyles } from '../../constants/Styles';
import { StorageService } from '../../services/StorageService';
import { EmergencyContact } from '../../types';
import i18n from '../../localization/i18n';

const COUNTRY_CODES = [
  // North America
  { code: '+1', country: 'US/CA', flag: 'ğŸ‡ºğŸ‡¸', name: 'United States / Canada' },
  
  // Europe
  { code: '+44', country: 'UK', flag: 'ğŸ‡¬ğŸ‡§', name: 'United Kingdom' },
  { code: '+33', country: 'FR', flag: 'ğŸ‡«ğŸ‡·', name: 'France' },
  { code: '+49', country: 'DE', flag: 'ğŸ‡©ğŸ‡ª', name: 'Germany' },
  { code: '+39', country: 'IT', flag: 'ğŸ‡®ğŸ‡¹', name: 'Italy' },
  { code: '+34', country: 'ES', flag: 'ğŸ‡ªğŸ‡¸', name: 'Spain' },
  { code: '+351', country: 'PT', flag: 'ğŸ‡µğŸ‡¹', name: 'Portugal' },
  { code: '+31', country: 'NL', flag: 'ğŸ‡³ğŸ‡±', name: 'Netherlands' },
  { code: '+32', country: 'BE', flag: 'ğŸ‡§ğŸ‡ª', name: 'Belgium' },
  { code: '+41', country: 'CH', flag: 'ğŸ‡¨ğŸ‡­', name: 'Switzerland' },
  { code: '+43', country: 'AT', flag: 'ğŸ‡¦ğŸ‡¹', name: 'Austria' },
  { code: '+45', country: 'DK', flag: 'ğŸ‡©ğŸ‡°', name: 'Denmark' },
  { code: '+46', country: 'SE', flag: 'ğŸ‡¸ğŸ‡ª', name: 'Sweden' },
  { code: '+47', country: 'NO', flag: 'ğŸ‡³ğŸ‡´', name: 'Norway' },
  { code: '+358', country: 'FI', flag: 'ğŸ‡«ğŸ‡®', name: 'Finland' },
  { code: '+7', country: 'RU', flag: 'ğŸ‡·ğŸ‡º', name: 'Russia' },
  { code: '+48', country: 'PL', flag: 'ğŸ‡µğŸ‡±', name: 'Poland' },
  { code: '+420', country: 'CZ', flag: 'ğŸ‡¨ğŸ‡¿', name: 'Czech Republic' },
  { code: '+421', country: 'SK', flag: 'ğŸ‡¸ğŸ‡°', name: 'Slovakia' },
  { code: '+36', country: 'HU', flag: 'ğŸ‡­ğŸ‡º', name: 'Hungary' },
  { code: '+40', country: 'RO', flag: 'ğŸ‡·ğŸ‡´', name: 'Romania' },
  { code: '+359', country: 'BG', flag: 'ğŸ‡§ğŸ‡¬', name: 'Bulgaria' },
  { code: '+385', country: 'HR', flag: 'ğŸ‡­ğŸ‡·', name: 'Croatia' },
  { code: '+381', country: 'RS', flag: 'ğŸ‡·ğŸ‡¸', name: 'Serbia' },
  { code: '+386', country: 'SI', flag: 'ğŸ‡¸ğŸ‡®', name: 'Slovenia' },
  { code: '+372', country: 'EE', flag: 'ğŸ‡ªğŸ‡ª', name: 'Estonia' },
  { code: '+371', country: 'LV', flag: 'ğŸ‡±ğŸ‡»', name: 'Latvia' },
  { code: '+370', country: 'LT', flag: 'ğŸ‡±ğŸ‡¹', name: 'Lithuania' },
  { code: '+380', country: 'UA', flag: 'ğŸ‡ºğŸ‡¦', name: 'Ukraine' },
  { code: '+375', country: 'BY', flag: 'ğŸ‡§ğŸ‡¾', name: 'Belarus' },
  { code: '+389', country: 'MK', flag: 'ğŸ‡²ğŸ‡°', name: 'North Macedonia' },
  { code: '+355', country: 'AL', flag: 'ğŸ‡¦ğŸ‡±', name: 'Albania' },
  { code: '+356', country: 'MT', flag: 'ğŸ‡²ğŸ‡¹', name: 'Malta' },
  { code: '+354', country: 'IS', flag: 'ğŸ‡®ğŸ‡¸', name: 'Iceland' },
  { code: '+353', country: 'IE', flag: 'ğŸ‡®ğŸ‡ª', name: 'Ireland' },
  
  // Asia
  { code: '+86', country: 'CN', flag: 'ğŸ‡¨ğŸ‡³', name: 'China' },
  { code: '+81', country: 'JP', flag: 'ğŸ‡¯ğŸ‡µ', name: 'Japan' },
  { code: '+82', country: 'KR', flag: 'ğŸ‡°ğŸ‡·', name: 'South Korea' },
  { code: '+91', country: 'IN', flag: 'ğŸ‡®ğŸ‡³', name: 'India' },
  { code: '+92', country: 'PK', flag: 'ğŸ‡µğŸ‡°', name: 'Pakistan' },
  { code: '+880', country: 'BD', flag: 'ğŸ‡§ğŸ‡©', name: 'Bangladesh' },
  { code: '+94', country: 'LK', flag: 'ğŸ‡±ğŸ‡°', name: 'Sri Lanka' },
  { code: '+977', country: 'NP', flag: 'ğŸ‡³ğŸ‡µ', name: 'Nepal' },
  { code: '+975', country: 'BT', flag: 'ğŸ‡§ğŸ‡¹', name: 'Bhutan' },
  { code: '+960', country: 'MV', flag: 'ğŸ‡²ğŸ‡»', name: 'Maldives' },
  { code: '+65', country: 'SG', flag: 'ğŸ‡¸ğŸ‡¬', name: 'Singapore' },
  { code: '+60', country: 'MY', flag: 'ğŸ‡²ğŸ‡¾', name: 'Malaysia' },
  { code: '+66', country: 'TH', flag: 'ğŸ‡¹ğŸ‡­', name: 'Thailand' },
  { code: '+84', country: 'VN', flag: 'ğŸ‡»ğŸ‡³', name: 'Vietnam' },
  { code: '+63', country: 'PH', flag: 'ğŸ‡µğŸ‡­', name: 'Philippines' },
  { code: '+62', country: 'ID', flag: 'ğŸ‡®ğŸ‡©', name: 'Indonesia' },
  { code: '+673', country: 'BN', flag: 'ğŸ‡§ğŸ‡³', name: 'Brunei' },
  { code: '+856', country: 'LA', flag: 'ğŸ‡±ğŸ‡¦', name: 'Laos' },
  { code: '+855', country: 'KH', flag: 'ğŸ‡°ğŸ‡­', name: 'Cambodia' },
  { code: '+95', country: 'MM', flag: 'ğŸ‡²ğŸ‡²', name: 'Myanmar' },
  { code: '+98', country: 'IR', flag: 'ğŸ‡®ğŸ‡·', name: 'Iran' },
  { code: '+964', country: 'IQ', flag: 'ğŸ‡®ğŸ‡¶', name: 'Iraq' },
  { code: '+90', country: 'TR', flag: 'ğŸ‡¹ğŸ‡·', name: 'Turkey' },
  { code: '+972', country: 'IL', flag: 'ğŸ‡®ğŸ‡±', name: 'Israel' },
  { code: '+961', country: 'LB', flag: 'ğŸ‡±ğŸ‡§', name: 'Lebanon' },
  { code: '+963', country: 'SY', flag: 'ğŸ‡¸ğŸ‡¾', name: 'Syria' },
  { code: '+962', country: 'JO', flag: 'ğŸ‡¯ğŸ‡´', name: 'Jordan' },
  { code: '+970', country: 'PS', flag: 'ğŸ‡µğŸ‡¸', name: 'Palestine' },
  { code: '+996', country: 'KG', flag: 'ğŸ‡°ğŸ‡¬', name: 'Kyrgyzstan' },
  { code: '+998', country: 'UZ', flag: 'ğŸ‡ºğŸ‡¿', name: 'Uzbekistan' },
  { code: '+992', country: 'TJ', flag: 'ğŸ‡¹ğŸ‡¯', name: 'Tajikistan' },
  { code: '+993', country: 'TM', flag: 'ğŸ‡¹ğŸ‡²', name: 'Turkmenistan' },
  { code: '+7', country: 'KZ', flag: 'ğŸ‡°ğŸ‡¿', name: 'Kazakhstan' },
  { code: '+976', country: 'MN', flag: 'ğŸ‡²ğŸ‡³', name: 'Mongolia' },
  { code: '+852', country: 'HK', flag: 'ğŸ‡­ğŸ‡°', name: 'Hong Kong' },
  { code: '+853', country: 'MO', flag: 'ğŸ‡²ğŸ‡´', name: 'Macau' },
  { code: '+886', country: 'TW', flag: 'ğŸ‡¹ğŸ‡¼', name: 'Taiwan' },
  
  // Middle East
  { code: '+971', country: 'AE', flag: 'ğŸ‡¦ğŸ‡ª', name: 'United Arab Emirates' },
  { code: '+966', country: 'SA', flag: 'ğŸ‡¸ğŸ‡¦', name: 'Saudi Arabia' },
  { code: '+974', country: 'QA', flag: 'ğŸ‡¶ğŸ‡¦', name: 'Qatar' },
  { code: '+973', country: 'BH', flag: 'ğŸ‡§ğŸ‡­', name: 'Bahrain' },
  { code: '+965', country: 'KW', flag: 'ğŸ‡°ğŸ‡¼', name: 'Kuwait' },
  { code: '+968', country: 'OM', flag: 'ğŸ‡´ğŸ‡²', name: 'Oman' },
  { code: '+967', country: 'YE', flag: 'ğŸ‡¾ğŸ‡ª', name: 'Yemen' },
  
  // Oceania
  { code: '+61', country: 'AU', flag: 'ğŸ‡¦ğŸ‡º', name: 'Australia' },
  { code: '+64', country: 'NZ', flag: 'ğŸ‡³ğŸ‡¿', name: 'New Zealand' },
  { code: '+679', country: 'FJ', flag: 'ğŸ‡«ğŸ‡¯', name: 'Fiji' },
  { code: '+685', country: 'WS', flag: 'ğŸ‡¼ğŸ‡¸', name: 'Samoa' },
  { code: '+676', country: 'TO', flag: 'ğŸ‡¹ğŸ‡´', name: 'Tonga' },
  { code: '+678', country: 'VU', flag: 'ğŸ‡»ğŸ‡º', name: 'Vanuatu' },
  { code: '+687', country: 'NC', flag: 'ğŸ‡³ğŸ‡¨', name: 'New Caledonia' },
  { code: '+689', country: 'PF', flag: 'ğŸ‡µğŸ‡«', name: 'French Polynesia' },
  
  // South America
  { code: '+55', country: 'BR', flag: 'ğŸ‡§ğŸ‡·', name: 'Brazil' },
  { code: '+52', country: 'MX', flag: 'ğŸ‡²ğŸ‡½', name: 'Mexico' },
  { code: '+54', country: 'AR', flag: 'ğŸ‡¦ğŸ‡·', name: 'Argentina' },
  { code: '+56', country: 'CL', flag: 'ğŸ‡¨ğŸ‡±', name: 'Chile' },
  { code: '+57', country: 'CO', flag: 'ğŸ‡¨ğŸ‡´', name: 'Colombia' },
  { code: '+51', country: 'PE', flag: 'ğŸ‡µğŸ‡ª', name: 'Peru' },
  { code: '+58', country: 'VE', flag: 'ğŸ‡»ğŸ‡ª', name: 'Venezuela' },
  { code: '+593', country: 'EC', flag: 'ğŸ‡ªğŸ‡¨', name: 'Ecuador' },
  { code: '+591', country: 'BO', flag: 'ğŸ‡§ğŸ‡´', name: 'Bolivia' },
  { code: '+595', country: 'PY', flag: 'ğŸ‡µğŸ‡¾', name: 'Paraguay' },
  { code: '+598', country: 'UY', flag: 'ğŸ‡ºğŸ‡¾', name: 'Uruguay' },
  { code: '+597', country: 'SR', flag: 'ğŸ‡¸ğŸ‡·', name: 'Suriname' },
  { code: '+592', country: 'GY', flag: 'ğŸ‡¬ğŸ‡¾', name: 'Guyana' },
  { code: '+594', country: 'GF', flag: 'ğŸ‡¬ğŸ‡«', name: 'French Guiana' },
  
  // Africa
  { code: '+27', country: 'ZA', flag: 'ğŸ‡¿ğŸ‡¦', name: 'South Africa' },
  { code: '+20', country: 'EG', flag: 'ğŸ‡ªğŸ‡¬', name: 'Egypt' },
  { code: '+234', country: 'NG', flag: 'ğŸ‡³ğŸ‡¬', name: 'Nigeria' },
  { code: '+254', country: 'KE', flag: 'ğŸ‡°ğŸ‡ª', name: 'Kenya' },
  { code: '+255', country: 'TZ', flag: 'ğŸ‡¹ğŸ‡¿', name: 'Tanzania' },
  { code: '+256', country: 'UG', flag: 'ğŸ‡ºğŸ‡¬', name: 'Uganda' },
  { code: '+250', country: 'RW', flag: 'ğŸ‡·ğŸ‡¼', name: 'Rwanda' },
  { code: '+257', country: 'BI', flag: 'ğŸ‡§ğŸ‡®', name: 'Burundi' },
  { code: '+251', country: 'ET', flag: 'ğŸ‡ªğŸ‡¹', name: 'Ethiopia' },
  { code: '+252', country: 'SO', flag: 'ğŸ‡¸ğŸ‡´', name: 'Somalia' },
  { code: '+253', country: 'DJ', flag: 'ğŸ‡©ğŸ‡¯', name: 'Djibouti' },
  { code: '+291', country: 'ER', flag: 'ğŸ‡ªğŸ‡·', name: 'Eritrea' },
  { code: '+249', country: 'SD', flag: 'ğŸ‡¸ğŸ‡©', name: 'Sudan' },
  { code: '+211', country: 'SS', flag: 'ğŸ‡¸ğŸ‡¸', name: 'South Sudan' },
  { code: '+218', country: 'LY', flag: 'ğŸ‡±ğŸ‡¾', name: 'Libya' },
  { code: '+216', country: 'TN', flag: 'ğŸ‡¹ğŸ‡³', name: 'Tunisia' },
  { code: '+213', country: 'DZ', flag: 'ğŸ‡©ğŸ‡¿', name: 'Algeria' },
  { code: '+212', country: 'MA', flag: 'ğŸ‡²ğŸ‡¦', name: 'Morocco' },
  { code: '+221', country: 'SN', flag: 'ğŸ‡¸ğŸ‡³', name: 'Senegal' },
  { code: '+223', country: 'ML', flag: 'ğŸ‡²ğŸ‡±', name: 'Mali' },
  { code: '+226', country: 'BF', flag: 'ğŸ‡§ğŸ‡«', name: 'Burkina Faso' },
  { code: '+227', country: 'NE', flag: 'ğŸ‡³ğŸ‡ª', name: 'Niger' },
  { code: '+235', country: 'TD', flag: 'ğŸ‡¹ğŸ‡©', name: 'Chad' },
  { code: '+236', country: 'CF', flag: 'ğŸ‡¨ğŸ‡«', name: 'Central African Republic' },
  { code: '+237', country: 'CM', flag: 'ğŸ‡¨ğŸ‡²', name: 'Cameroon' },
  { code: '+240', country: 'GQ', flag: 'ğŸ‡¬ğŸ‡¶', name: 'Equatorial Guinea' },
  { code: '+241', country: 'GA', flag: 'ğŸ‡¬ğŸ‡¦', name: 'Gabon' },
  { code: '+242', country: 'CG', flag: 'ğŸ‡¨ğŸ‡¬', name: 'Republic of the Congo' },
  { code: '+243', country: 'CD', flag: 'ğŸ‡¨ğŸ‡©', name: 'Democratic Republic of the Congo' },
  { code: '+244', country: 'AO', flag: 'ğŸ‡¦ğŸ‡´', name: 'Angola' },
  { code: '+260', country: 'ZM', flag: 'ğŸ‡¿ğŸ‡²', name: 'Zambia' },
  { code: '+263', country: 'ZW', flag: 'ğŸ‡¿ğŸ‡¼', name: 'Zimbabwe' },
  { code: '+264', country: 'NA', flag: 'ğŸ‡³ğŸ‡¦', name: 'Namibia' },
  { code: '+267', country: 'BW', flag: 'ğŸ‡§ğŸ‡¼', name: 'Botswana' },
  { code: '+268', country: 'SZ', flag: 'ğŸ‡¸ğŸ‡¿', name: 'Eswatini' },
  { code: '+266', country: 'LS', flag: 'ğŸ‡±ğŸ‡¸', name: 'Lesotho' },
  { code: '+261', country: 'MG', flag: 'ğŸ‡²ğŸ‡¬', name: 'Madagascar' },
  { code: '+230', country: 'MU', flag: 'ğŸ‡²ğŸ‡º', name: 'Mauritius' },
  { code: '+248', country: 'SC', flag: 'ğŸ‡¸ğŸ‡¨', name: 'Seychelles' },
  { code: '+269', country: 'KM', flag: 'ğŸ‡°ğŸ‡²', name: 'Comoros' },
  { code: '+262', country: 'RE', flag: 'ğŸ‡·ğŸ‡ª', name: 'RÃ©union' },
  { code: '+290', country: 'SH', flag: 'ğŸ‡¸ğŸ‡­', name: 'Saint Helena' },
  
  // Caribbean
  { code: '+1242', country: 'BS', flag: 'ğŸ‡§ğŸ‡¸', name: 'Bahamas' },
  { code: '+1246', country: 'BB', flag: 'ğŸ‡§ğŸ‡§', name: 'Barbados' },
  { code: '+1284', country: 'VG', flag: 'ğŸ‡»ğŸ‡¬', name: 'British Virgin Islands' },
  { code: '+1345', country: 'KY', flag: 'ğŸ‡°ğŸ‡¾', name: 'Cayman Islands' },
  { code: '+53', country: 'CU', flag: 'ğŸ‡¨ğŸ‡º', name: 'Cuba' },
  { code: '+1767', country: 'DM', flag: 'ğŸ‡©ğŸ‡²', name: 'Dominica' },
  { code: '+1809', country: 'DO', flag: 'ğŸ‡©ğŸ‡´', name: 'Dominican Republic' },
  { code: '+1473', country: 'GD', flag: 'ğŸ‡¬ğŸ‡©', name: 'Grenada' },
  { code: '+509', country: 'HT', flag: 'ğŸ‡­ğŸ‡¹', name: 'Haiti' },
  { code: '+1876', country: 'JM', flag: 'ğŸ‡¯ğŸ‡²', name: 'Jamaica' },
  { code: '+1664', country: 'MS', flag: 'ğŸ‡²ğŸ‡¸', name: 'Montserrat' },
  { code: '+1787', country: 'PR', flag: 'ğŸ‡µğŸ‡·', name: 'Puerto Rico' },
  { code: '+1869', country: 'KN', flag: 'ğŸ‡°ğŸ‡³', name: 'Saint Kitts and Nevis' },
  { code: '+1758', country: 'LC', flag: 'ğŸ‡±ğŸ‡¨', name: 'Saint Lucia' },
  { code: '+1784', country: 'VC', flag: 'ğŸ‡»ğŸ‡¨', name: 'Saint Vincent and the Grenadines' },
  { code: '+1868', country: 'TT', flag: 'ğŸ‡¹ğŸ‡¹', name: 'Trinidad and Tobago' },
  { code: '+1649', country: 'TC', flag: 'ğŸ‡¹ğŸ‡¨', name: 'Turks and Caicos Islands' },
  { code: '+1340', country: 'VI', flag: 'ğŸ‡»ğŸ‡®', name: 'U.S. Virgin Islands' },
];

// Helper function to extract country code from phone number
const extractCountryCode = (phoneNumber: string): string => {
  if (!phoneNumber) return '+1';
  
  // Remove any spaces and ensure it starts with +
  const cleanNumber = phoneNumber.replace(/\s+/g, '');
  if (!cleanNumber.startsWith('+')) return '+1';
  
  // Sort by length (longest first) to match longer codes first
  const sortedCodes = COUNTRY_CODES.sort((a, b) => b.code.length - a.code.length);
  
  for (const country of sortedCodes) {
    if (cleanNumber.startsWith(country.code)) {
      return country.code;
    }
  }
  return '+1'; // Default fallback
};

// Helper function to remove country code from phone number
const removeCountryCode = (phoneNumber: string, countryCode: string): string => {
  if (!phoneNumber) return '';
  const cleanNumber = phoneNumber.replace(/\s+/g, '');
  if (cleanNumber.startsWith(countryCode)) {
    return cleanNumber.substring(countryCode.length);
  }
  return cleanNumber.replace(/^\+/, ''); // Remove + if present
};

export default function ContactsScreen() {
  const { colors } = useTheme();
  const [contacts, setContacts] = useState<EmergencyContact[]>([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [showAddForm, setShowAddForm] = useState(false);
  const [editingContact, setEditingContact] = useState<EmergencyContact | null>(null);
  const [showCountryPicker, setShowCountryPicker] = useState(false);
  const [countrySearchQuery, setCountrySearchQuery] = useState('');
  const [selectedCountryCode, setSelectedCountryCode] = useState('+1');
  const [whatsappCountryCode, setWhatsappCountryCode] = useState('+1');
  const [currentField, setCurrentField] = useState<'phone' | 'whatsapp'>('phone');

  const styles = createStyles(colors);

  useEffect(() => {
    loadContacts();
  }, []);

  const loadContacts = async () => {
    const savedContacts = await StorageService.getEmergencyContacts();
    setContacts(savedContacts);
  };

  const filteredContacts = contacts.filter(contact =>
    contact.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
    contact.phone.includes(searchQuery) ||
    contact.relationship.toLowerCase().includes(searchQuery.toLowerCase())
  );

  // Filter countries based on search query
  const filteredCountries = COUNTRY_CODES.filter(country =>
    country.name.toLowerCase().includes(countrySearchQuery.toLowerCase()) ||
    country.country.toLowerCase().includes(countrySearchQuery.toLowerCase()) ||
    country.code.includes(countrySearchQuery)
  );

  const handleAddContact = () => {
    setEditingContact(null);
    setSelectedCountryCode('+1');
    setWhatsappCountryCode('+1');
    setShowAddForm(true);
  };

  const handleEditContact = (contact: EmergencyContact) => {
    setEditingContact(contact);
    
    // Extract country codes from existing phone numbers
    const phoneCountryCode = extractCountryCode(contact.phone);
    const whatsappCode = contact.whatsappNumber ? extractCountryCode(contact.whatsappNumber) : '+1';
    
    setSelectedCountryCode(phoneCountryCode);
    setWhatsappCountryCode(whatsappCode);
    setShowAddForm(true);
  };

  const handleDeleteContact = (contactId: string) => {
    Alert.alert(
      i18n.t('contacts.deleteContact'),
      i18n.t('contacts.deleteContactConfirm'),
      [
        { text: i18n.t('common.cancel'), style: 'cancel' },
        {
          text: i18n.t('common.delete'),
          style: 'destructive',
          onPress: async () => {
            const updatedContacts = contacts.filter(c => c.id !== contactId);
            setContacts(updatedContacts);
            await StorageService.saveEmergencyContacts(updatedContacts);
          },
        },
      ]
    );
  };

  const openCountryPicker = (field: 'phone' | 'whatsapp') => {
    setCurrentField(field);
    setCountrySearchQuery('');
    setShowCountryPicker(true);
  };

  const selectCountryCode = (code: string) => {
    if (currentField === 'phone') {
      setSelectedCountryCode(code);
    } else {
      setWhatsappCountryCode(code);
    }
    setShowCountryPicker(false);
    setCountrySearchQuery('');
  };

  const CountryPickerModal = () => (
    <Modal visible={showCountryPicker} transparent animationType="slide">
      <View style={styles.modalOverlay}>
        <View style={[styles.countryPickerModal, { backgroundColor: colors.background.primary }]}>
          <View style={[styles.modalHeader, { borderBottomColor: colors.border.light }]}>
            <Text style={[styles.modalTitle, { color: colors.text.primary }]}>
              {i18n.t('contacts.countryCode')} ({COUNTRY_CODES.length} countries)
            </Text>
            <TouchableOpacity onPress={() => {
              setShowCountryPicker(false);
              setCountrySearchQuery('');
            }}>
              <Text style={[styles.modalClose, { color: colors.primary }]}>
                {i18n.t('common.cancel')}
              </Text>
            </TouchableOpacity>
          </View>

          {/* Search Bar */}
          <View style={[styles.searchContainer, { borderBottomColor: colors.border.light }]}>
            <View style={[styles.searchBar, { backgroundColor: colors.background.secondary }]}>
              <Search size={20} color={colors.text.tertiary} />
              <TextInput
                style={[styles.searchInput, { color: colors.text.primary }]}
                placeholder="Search countries..."
                value={countrySearchQuery}
                onChangeText={setCountrySearchQuery}
                placeholderTextColor={colors.text.tertiary}
              />
            </View>
          </View>
          
          <ScrollView style={styles.countryList}>
            {filteredCountries.map((country) => (
              <TouchableOpacity
                key={`${country.code}-${country.country}`}
                style={[styles.countryItem, { borderBottomColor: colors.border.light }]}
                onPress={() => selectCountryCode(country.code)}
              >
                <Text style={styles.countryFlag}>{country.flag}</Text>
                <View style={styles.countryInfo}>
                  <Text style={[styles.countryName, { color: colors.text.primary }]}>
                    {country.name}
                  </Text>
                  <Text style={[styles.countryCode, { color: colors.text.secondary }]}>
                    {country.code}
                  </Text>
                </View>
              </TouchableOpacity>
            ))}
            {filteredCountries.length === 0 && (
              <View style={styles.noResultsContainer}>
                <Text style={[styles.noResultsText, { color: colors.text.secondary }]}>
                  No countries found matching "{countrySearchQuery}"
                </Text>
              </View>
            )}
          </ScrollView>
        </View>
      </View>
    </Modal>
  );

  if (showAddForm) {
    return (
      <ContactForm
        contact={editingContact}
        onSave={async (contactData) => {
          if (!contactData.name || !contactData.phone || !contactData.relationship) {
            Alert.alert(i18n.t('common.error'), i18n.t('contacts.fillAllFields'));
            return;
          }

          let updatedContacts: EmergencyContact[];

          if (editingContact) {
            updatedContacts = contacts.map(contact =>
              contact.id === editingContact.id
                ? { ...contact, ...contactData }
                : contact
            );
          } else {
            const newContact: EmergencyContact = {
              id: Date.now().toString(),
              name: contactData.name!,
              phone: contactData.phone!,
              email: contactData.email || '',
              whatsappNumber: contactData.whatsappNumber || '',
              relationship: contactData.relationship!,
              isPrimary: contactData.isPrimary || false,
              createdAt: new Date().toISOString(),
            };
            updatedContacts = [...contacts, newContact];
          }

          setContacts(updatedContacts);
          await StorageService.saveEmergencyContacts(updatedContacts);
          setShowAddForm(false);
          setEditingContact(null);
          Alert.alert(i18n.t('common.success'), i18n.t('contacts.contactSaved'));
        }}
        onCancel={() => {
          setShowAddForm(false);
          setEditingContact(null);
        }}
        colors={colors}
        selectedCountryCode={selectedCountryCode}
        whatsappCountryCode={whatsappCountryCode}
        onOpenCountryPicker={openCountryPicker}
      />
    );
  }

  return (
    <SafeAreaView style={[CommonStyles.safeArea, { backgroundColor: colors.background.primary }]}>
      <View style={[styles.container, { backgroundColor: colors.background.primary }]}>
        <View style={styles.header}>
          <Text style={[CommonStyles.header, { color: colors.text.primary }]}>
            {i18n.t('contacts.title')}
          </Text>
          <Text style={[CommonStyles.body, { color: colors.text.secondary }]}>
            {i18n.t('contacts.subtitle')}
          </Text>
        </View>

        <View style={styles.searchContainer}>
          <View style={[styles.searchBar, { backgroundColor: colors.background.secondary }]}>
            <Search size={20} color={colors.text.tertiary} />
            <TextInput
              style={[styles.searchInput, { color: colors.text.primary }]}
              placeholder={i18n.t('contacts.searchPlaceholder')}
              value={searchQuery}
              onChangeText={setSearchQuery}
              placeholderTextColor={colors.text.tertiary}
            />
          </View>
          
          <TouchableOpacity 
            style={[styles.addButton, { backgroundColor: colors.primary }]} 
            onPress={handleAddContact}
          >
            <Plus size={24} color={colors.text.inverse} />
          </TouchableOpacity>
        </View>

        <ScrollView style={styles.list} showsVerticalScrollIndicator={false}>
          {filteredContacts.length === 0 ? (
            <View style={styles.emptyContainer}>
              <Text style={[styles.emptyText, { color: colors.text.secondary }]}>
                {searchQuery ? i18n.t('contacts.noContactsFound') : i18n.t('contacts.noContacts')}
              </Text>
              {!searchQuery && (
                <TouchableOpacity
                  style={[CommonStyles.button, styles.emptyButton, { backgroundColor: colors.primary }]}
                  onPress={handleAddContact}
                >
                  <Text style={[CommonStyles.buttonText, { color: colors.text.inverse }]}>
                    {i18n.t('contacts.addFirstContact')}
                  </Text>
                </TouchableOpacity>
              )}
            </View>
          ) : (
            filteredContacts.map(contact => (
              <ContactCard
                key={contact.id}
                contact={contact}
                onEdit={() => handleEditContact(contact)}
                onDelete={() => handleDeleteContact(contact.id)}
                colors={colors}
              />
            ))
          )}
        </ScrollView>

        <CountryPickerModal />
      </View>
    </SafeAreaView>
  );
}

interface ContactFormProps {
  contact: EmergencyContact | null;
  onSave: (contact: Partial<EmergencyContact>) => void;
  onCancel: () => void;
  colors: any;
  selectedCountryCode: string;
  whatsappCountryCode: string;
  onOpenCountryPicker: (field: 'phone' | 'whatsapp') => void;
}

function ContactForm({ 
  contact, 
  onSave, 
  onCancel, 
  colors, 
  selectedCountryCode, 
  whatsappCountryCode, 
  onOpenCountryPicker 
}: ContactFormProps) {
  const [name, setName] = useState(contact?.name || '');
  const [phone, setPhone] = useState('');
  const [email, setEmail] = useState(contact?.email || '');
  const [whatsappNumber, setWhatsappNumber] = useState('');
  const [relationship, setRelationship] = useState(contact?.relationship || '');
  const [isPrimary, setIsPrimary] = useState(contact?.isPrimary || false);

  const styles = createStyles(colors);

  // Initialize phone numbers without country codes when editing
  useEffect(() => {
    if (contact) {
      // Remove country code from phone number for display
      const phoneWithoutCode = removeCountryCode(contact.phone, extractCountryCode(contact.phone));
      setPhone(phoneWithoutCode);
      
      if (contact.whatsappNumber) {
        const whatsappWithoutCode = removeCountryCode(contact.whatsappNumber, extractCountryCode(contact.whatsappNumber));
        setWhatsappNumber(whatsappWithoutCode);
      }
    }
  }, [contact]);

  const handleSave = () => {
    // Clean phone numbers and combine with country codes
    const cleanPhone = phone.replace(/^\+/, '').replace(/\s+/g, '');
    const cleanWhatsapp = whatsappNumber.replace(/^\+/, '').replace(/\s+/g, '');
    
    const fullPhone = selectedCountryCode + cleanPhone;
    const fullWhatsapp = cleanWhatsapp ? whatsappCountryCode + cleanWhatsapp : '';

    onSave({
      name,
      phone: fullPhone,
      email,
      whatsappNumber: fullWhatsapp,
      relationship,
      isPrimary,
    });
  };

  return (
    <SafeAreaView style={[CommonStyles.safeArea, { backgroundColor: colors.background.primary }]}>
      <View style={[styles.formContainer, { backgroundColor: colors.background.primary }]}>
        <View style={styles.formHeader}>
          <Text style={[CommonStyles.header, { color: colors.text.primary }]}>
            {contact ? i18n.t('contacts.editContact') : i18n.t('contacts.addContact')}
          </Text>
          <TouchableOpacity onPress={onCancel}>
            <Text style={[styles.cancelText, { color: colors.primary }]}>
              {i18n.t('common.cancel')}
            </Text>
          </TouchableOpacity>
        </View>

        <ScrollView style={styles.formContent} showsVerticalScrollIndicator={false}>
          <View style={styles.inputGroup}>
            <Text style={[styles.label, { color: colors.text.primary }]}>
              {i18n.t('contacts.name')} *
            </Text>
            <TextInput
              style={[CommonStyles.input, styles.input, { backgroundColor: colors.background.primary, borderColor: colors.border.medium, color: colors.text.primary }]}
              value={name}
              onChangeText={setName}
              placeholder="Enter full name"
              placeholderTextColor={colors.text.tertiary}
            />
          </View>

          <View style={styles.inputGroup}>
            <Text style={[styles.label, { color: colors.text.primary }]}>
              {i18n.t('contacts.phone')} *
            </Text>
            <View style={styles.phoneInputContainer}>
              <TouchableOpacity
                style={[styles.countryCodeButton, { backgroundColor: colors.background.secondary, borderColor: colors.border.medium }]}
                onPress={() => onOpenCountryPicker('phone')}
              >
                <Globe size={16} color={colors.text.secondary} />
                <Text style={[styles.countryCodeText, { color: colors.text.primary }]}>
                  {selectedCountryCode}
                </Text>
              </TouchableOpacity>
              <TextInput
                style={[CommonStyles.input, styles.phoneInput, { backgroundColor: colors.background.primary, borderColor: colors.border.medium, color: colors.text.primary }]}
                value={phone}
                onChangeText={setPhone}
                placeholder={i18n.t('contacts.phoneNumber')}
                keyboardType="phone-pad"
                placeholderTextColor={colors.text.tertiary}
              />
            </View>
          </View>

          <View style={styles.inputGroup}>
            <Text style={[styles.label, { color: colors.text.primary }]}>
              {i18n.t('contacts.email')} ({i18n.t('contacts.optional')})
            </Text>
            <TextInput
              style={[CommonStyles.input, styles.input, { backgroundColor: colors.background.primary, borderColor: colors.border.medium, color: colors.text.primary }]}
              value={email}
              onChangeText={setEmail}
              placeholder="Enter email address"
              keyboardType="email-address"
              autoCapitalize="none"
              placeholderTextColor={colors.text.tertiary}
            />
          </View>

          <View style={styles.inputGroup}>
            <Text style={[styles.label, { color: colors.text.primary }]}>
              {i18n.t('contacts.whatsapp')} ({i18n.t('contacts.optional')})
            </Text>
            <View style={styles.phoneInputContainer}>
              <TouchableOpacity
                style={[styles.countryCodeButton, { backgroundColor: colors.background.secondary, borderColor: colors.border.medium }]}
                onPress={() => onOpenCountryPicker('whatsapp')}
              >
                <Globe size={16} color={colors.text.secondary} />
                <Text style={[styles.countryCodeText, { color: colors.text.primary }]}>
                  {whatsappCountryCode}
                </Text>
              </TouchableOpacity>
              <TextInput
                style={[CommonStyles.input, styles.phoneInput, { backgroundColor: colors.background.primary, borderColor: colors.border.medium, color: colors.text.primary }]}
                value={whatsappNumber}
                onChangeText={setWhatsappNumber}
                placeholder="WhatsApp number"
                keyboardType="phone-pad"
                placeholderTextColor={colors.text.tertiary}
              />
            </View>
          </View>

          <View style={styles.inputGroup}>
            <Text style={[styles.label, { color: colors.text.primary }]}>
              {i18n.t('contacts.relationship')} *
            </Text>
            <TextInput
              style={[CommonStyles.input, styles.input, { backgroundColor: colors.background.primary, borderColor: colors.border.medium, color: colors.text.primary }]}
              value={relationship}
              onChangeText={setRelationship}
              placeholder={i18n.t('contacts.relationshipPlaceholder')}
              placeholderTextColor={colors.text.tertiary}
            />
          </View>

          <TouchableOpacity
            style={styles.checkboxContainer}
            onPress={() => setIsPrimary(!isPrimary)}
          >
            <View style={[styles.checkbox, { borderColor: colors.border.medium }, isPrimary && { backgroundColor: colors.primary, borderColor: colors.primary }]}>
              {isPrimary && <Text style={[styles.checkmark, { color: colors.text.inverse }]}>âœ“</Text>}
            </View>
            <Text style={[styles.checkboxLabel, { color: colors.text.primary }]}>
              {i18n.t('contacts.primaryContact')}
            </Text>
          </TouchableOpacity>
        </ScrollView>

        <View style={styles.buttonContainer}>
          <TouchableOpacity
            style={[CommonStyles.button, styles.saveButton, { backgroundColor: colors.primary }]}
            onPress={handleSave}
          >
            <Text style={[CommonStyles.buttonText, { color: colors.text.inverse }]}>
              {contact ? 'Update' : i18n.t('common.save')} Contact
            </Text>
          </TouchableOpacity>
        </View>
      </View>
    </SafeAreaView>
  );
}

const createStyles = (colors: any) => StyleSheet.create({
  container: {
    flex: 1,
  },
  
  header: {
    padding: 20,
    paddingBottom: 16,
  },
  
  searchContainer: {
    flexDirection: 'row',
    paddingHorizontal: 20,
    paddingBottom: 16,
    alignItems: 'center',
  },
  
  searchBar: {
    flex: 1,
    flexDirection: 'row',
    alignItems: 'center',
    borderRadius: 12,
    paddingHorizontal: 16,
    paddingVertical: 12,
    marginRight: 12,
  },
  
  searchInput: {
    flex: 1,
    marginLeft: 12,
    fontSize: 16,
  },
  
  addButton: {
    width: 48,
    height: 48,
    borderRadius: 24,
    alignItems: 'center',
    justifyContent: 'center',
  },
  
  list: {
    flex: 1,
    paddingHorizontal: 20,
  },
  
  emptyContainer: {
    flex: 1,
    alignItems: 'center',
    justifyContent: 'center',
    padding: 40,
  },
  
  emptyText: {
    fontSize: 16,
    textAlign: 'center',
    marginBottom: 20,
  },
  
  emptyButton: {
    paddingVertical: 16,
  },
  
  formContainer: {
    flex: 1,
  },

  formHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    padding: 20,
    paddingBottom: 16,
  },

  cancelText: {
    fontSize: 16,
    fontWeight: '600',
  },
  
  formContent: {
    flex: 1,
    paddingHorizontal: 20,
  },
  
  inputGroup: {
    marginBottom: 20,
  },
  
  label: {
    fontSize: 16,
    fontWeight: '600',
    marginBottom: 8,
  },
  
  input: {
    fontSize: 16,
  },

  phoneInputContainer: {
    flexDirection: 'row',
    gap: 12,
  },

  countryCodeButton: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingHorizontal: 12,
    paddingVertical: 12,
    borderRadius: 8,
    borderWidth: 1,
    minWidth: 80,
  },

  countryCodeText: {
    fontSize: 16,
    fontWeight: '600',
    marginLeft: 8,
  },

  phoneInput: {
    flex: 1,
    fontSize: 16,
  },
  
  checkboxContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 20,
  },
  
  checkbox: {
    width: 20,
    height: 20,
    borderWidth: 2,
    borderRadius: 4,
    alignItems: 'center',
    justifyContent: 'center',
    marginRight: 12,
  },
  
  checkmark: {
    fontSize: 12,
    fontWeight: '700',
  },
  
  checkboxLabel: {
    fontSize: 16,
  },
  
  buttonContainer: {
    padding: 20,
  },
  
  saveButton: {
    paddingVertical: 16,
  },

  // Country Picker Modal
  modalOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
    justifyContent: 'flex-end',
  },

  countryPickerModal: {
    borderTopLeftRadius: 20,
    borderTopRightRadius: 20,
    maxHeight: '80%',
  },

  modalHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    padding: 20,
    borderBottomWidth: 1,
  },

  modalTitle: {
    fontSize: 18,
    fontWeight: '700',
  },

  modalClose: {
    fontSize: 16,
    fontWeight: '600',
  },

  searchContainer: {
    paddingHorizontal: 20,
    paddingVertical: 16,
    borderBottomWidth: 1,
  },

  countryList: {
    flex: 1,
  },

  countryItem: {
    flexDirection: 'row',
    alignItems: 'center',
    padding: 16,
    borderBottomWidth: 1,
  },

  countryFlag: {
    fontSize: 24,
    marginRight: 12,
  },

  countryInfo: {
    flex: 1,
  },

  countryName: {
    fontSize: 16,
    fontWeight: '600',
    marginBottom: 2,
  },

  countryCode: {
    fontSize: 14,
  },

  noResultsContainer: {
    padding: 40,
    alignItems: 'center',
  },

  noResultsText: {
    fontSize: 16,
    textAlign: 'center',
  },
});
